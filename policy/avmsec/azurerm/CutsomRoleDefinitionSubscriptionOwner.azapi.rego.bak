package avmsec

import rego.v1

valid_azurerm_role_definition_no_subscription_owner(resource) if {
    not contains(resource.permissions[0].actions, "*")
}

deny_AVM_SEC_39 contains reason if {
    resource := input.resource.azurerm_role_definition[_]
    not valid_azurerm_role_definition_no_subscription_owner(resource)

    reason := sprintf("avmsec/AVM_SEC_39: Ensure that no custom subscription owner roles are created %s", ["https://github.com/bridgecrewio/checkov/blob/main/checkov/terraform/checks/resource/azure/CutsomRoleDefinitionSubscriptionOwner.py"])
}


valid_azapi_role_definition_no_subscription_owner(resource) if {
    not contains(resource.body.properties.permissions[0].actions, "*")
}

deny_AVM_SEC_39_azapi contains reason if {
    resource_changes := input.resource.azapi_resource[_]
    resource_changes.changes.actions == ["create"]

    resource := resource_changes.changes.after
    resource.type == "Microsoft.Authorization/roleDefinitions/2022-05-01-preview"

    not valid_azapi_role_definition_no_subscription_owner(resource)

    reason := sprintf("avmsec/AVM_SEC_39: Ensure that no custom subscription owner roles are created %s", ["https://github.com/bridgecrewio/checkov/blob/main/checkov/terraform/checks/resource/azure/CutsomRoleDefinitionSubscriptionOwner.py"])
}
